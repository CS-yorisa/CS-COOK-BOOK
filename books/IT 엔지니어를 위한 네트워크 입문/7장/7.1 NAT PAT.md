# 7.1 NAT / PAT

## NAT

- Network Address Translation
- 네트워크 주소 변환 기술
  - 사설 IP → 공인 IP 1:1 변환이 기본
  - N : 1 (NAPT = PAT), IPv4 ↔ IPv6 (AFT) 등도 포함
- [L3] 라우터, L3 스위치 [L4] 방화벽, 로드 밸런서 등에서 사용됨



## NAT/PAT의 용도와 필요성

1. IPv4 주소 고갈문제의 솔루션
   - 현재는 할당 가능한 IPv4 주소가 없는 상태이나 이전에 단기, 중기, 장기 IP 보존과 전환전략 수립 시 사용
   - [단기] 서브네팅, [중기] NAT와 사설 IP, [장기] IPv6 전환
2. 보안 강화
   - 외부에서는 NAT 된 공인 IP를 사용하므로, 내부 IP 주소 체계를 숨길 수 있음
   - 내부에서 외부로의 통신은 허용하지만, 외부에서 내부로 들어오는 통신은 방어할 수 있음
3. IP 주소 체계가 같은 두 개의 네트워크 간 통신 가능
   - IP 대역이 같은 네트워크와 통신할 가능성이 높은 대외계 네트워크*를 연결하기 위해 출발지와 도착지를 한꺼번에 변환하는 Double NAT 기술 사용
4. 불필요한 설정 변경 감소
   - 회선 사업자나 IDC를 바꿀 경우에 내부 서버나 PC 설정 변경 최소화 가능
   - 특정 사업자에 종속되지 않는 유연한 인프라스트럭처 구성 가능



### NAT의 한계

- IP가 변환되면 장애 발생 시 문제 해결에 어려움
- 주소가 변환되며 단말 간 연결성이 무너짐
  - 이를 해결하기 위해 NAT 밑 단말도 직접 연결하게 도와주는 홀 펀칭 기술 출현





## NAT 동작 순서

![NAT / PAT 동작방식](https://t1.daumcdn.net/cfile/tistory/997692415FC8801E1D)

1. 웹 서버에 접근하기 위해 출발지 IP, 목적지 IP/포트 설정하여 패킷 전송. 출발지 포트는 임의 할당됨.
2. NAT 장비는 패킷 수신후, NAT 정책에 따라 IP 주소를 공인 IP로 주소 변경. 변경 전/후 주소는 NAT 테이블에 저장.
3. 출발지 주소가 공인 IP 주소로 변경된 패킷이 목적지 웹서버로 전송
4. 패킷을 수신한 웹 서버는 사용자에게 응답. 수신 내용과 반대로 출발지 / 목적지가 정해짐
5. 웹 서버로 부터 응답을 수신한 NAT 장비가 NAT 테이블에서 원래 출발지 IP를 확인
6. 목적지를 원래 출발지 IP로 변경하여 전송하면 최종 패킷 수신



## PAT 동작 순서

![img](https://t1.daumcdn.net/cfile/tistory/9974AC415FC8801F1D)

- NAT와 달리, IP 뿐 아니라 출발지 서비스 포트도 함께 변경됨
- 하나의 IP로도 다양한 포트 번호를 사용해서 사용자를 구분할 수 있음
  - 서비스 포트는 제한적이기 때문에 모두 사용중이거나 재사용할 수 없으면 동작하지 않음
  - 동시 사용자가 많을 경우 공인 IP를 풀(Pool)로 구성해야 함
- 다수의 IP가 있는 출발지에서 목적지로 갈 때 NAT 테이블이 생성 되고, 응답에 대해 NAT 테이블을 참조할 수 있으나, PAT IP가 목적지 일 경우 해당 IP가 어느 IP에 바인딩 되는지 확인할 수 없음
  - SNAT에만 적용되고 DNAT에는 적용되지 않음



## SNAT와 DNAT

- NAT가 수행되기 전의 트래픽이 출발하는 시작 지점을 기준으로 구분함

- SNAT (Source NAT) 
  - 출발지 주소를 변경하는 NAT
  - 사설에서 공인으로 통신 / 보안상의 이유 (이때는 꼭 공인IP로 변경될 필요는 없음) / 로드 밸런서의 구성에 따라

* DNAT (Destination NAT) 
  * 도착지 주소를 변경하는 NAT
  * 로드 밸런서 / 대외망과의 네트워크 구성



## 동적 NAT와 정적 NAT

- 정적 NAT
  - 출발지와 목적지의 IP를 미리 매핑해 고정해놓은 NAT, 1:1 NAT라고도 부름
  - 서비스 흐름을 고려하지 않고 방향성 없이 NAT 설정 가능
- 동적 NAT
  - 출발지나 목적지 어느 경우든 사전에 정해지지 않고 NAT 수행 시, IP를 동적으로 변경함
  - 출발지나 목적지 한 곳이 다수의 IP로 구성된 IP 풀이나 레인지로 설정되어 있음 (1:N, N:1, N:M)
  - 설정 시간 동안만 유지되고, 일정시간 통신이 없으면 사라짐 (NAT 테이블 타임 아웃)