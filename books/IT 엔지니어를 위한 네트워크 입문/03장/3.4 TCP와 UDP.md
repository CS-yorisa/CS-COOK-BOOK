# 3.4 TCP와 UDP 

- 4계층에서 동작하는 프로토콜
- 출발지에서 목적지까지 경로를 찾아가는 것이 끝이 아니라 애플리케이션이 정상적으로 돌아가기 위한 다양한 작업에 문제가 없어야 함



## 4계층 프로토콜과 서비스 포트

- 데이터를 보내고 받는 인캡슐레이션, 디캡슐레이션과정에서 헤더와 정보가 추가 됨
  - 이때 가장 중요한 두 가지 정보
    - 각 계층에서 정의하는 정보
    - 상위 프로토콜 지시자 정보

![img](https://velog.velcdn.com/images/indongcha/post/22b6ed18-4861-4d66-93a1-1b27075ba8c2/image.png)

- 각 계층을 정의하는 정보는 수신 측의 동일 계층에서 사용하기 위한 정보
- 상위 프로토콜 지시자는 디캡슐레이션 과정에서 상위 계층의 프로토콜이나 프로세스를 정확히 찾아가기 위함

- 4계층에서는 프로세스를 정확히 찾고, 데이터를 분할한 패킷을 분해 및 조립하는 것이 목적
  - 이를 위해, 시퀀스 번호와 ACK 번호 사용

![img](https://mblogthumb-phinf.pstatic.net/20160630_220/ndb796_1467276446779Uiraw_JPEG/%C7%EC%B4%F5%C7%EC%B4%F5.jpg?type=w800)

- TCP/IP 프로토콜 스택에서 4계층 상위 프로토콜 지시자는 포트 번호
- 일반적으로 TCP/IP에서 클라이언트-서버 방식으로 서비스를 제공하고 이 둘을 구분해 개발함
- 2~3 계층 상위 프로토콜 지시자는 출발지와 도착지를 구분하지 않았지만 4계층에서는 이를 구분함
  - 요청 패킷과 응답 패킷의 출발지와 도착지 포트번호가 반대가 됨



## TCP

- 4계층 프로토콜로 정보유실 없는 통신을 보장하기 위해 세션을 안전하게 연결하고, 데이터를 분할하고, 분할된 패킷이 잘 전송 되었는지 확인하는 기능이 있음
- 패킷에 번호(시퀀스 넘버)를 부여하고 잘 전송 되었는지 응답함
- 수신자가 잘 받아 처리할 수 있는 전송 크기를 고려하여 통신



### 패킷 순서, 응답 번호

- 시퀀스 번호 : 패킷에 순서를 부여하는 것
- ACK 번호 : 응답에 번호를 부여하는 것
- 두 번호가 상호작용해 순서가 바뀌거나 중간에 패킷이 손실된 것을 파악할 수 있음

![img](https://velog.velcdn.com/images/indongcha/post/3158b7a7-2a15-434c-b250-9400c1bbc87e/image.png)

1. 출발지에서 시퀀스 번호를 0으로 보냄
2. 수신 측에서는 0번 패킷을 잘 받았다는 표시로 ACK에 1을 적어 응답함. 이때 수신 측에서는 자신이 처음 보내는 패킷이므로 자신의 패킷에 시퀀스 번호 0을 부여함
3. 이 패킷을 받은 송신 측은 시퀀스 번호를 1로, ACK 번호는 상대방의 0번 시퀀스를 잘 받았다는 의미로 1을 부여해 다시 송신



### 윈도우 사이즈와 슬라이딩 윈도우

- 패킷을 주고받는 과정에서 통신 시간이 늘어나고, 송신자와 수신자의 거리가 멀면 왕복 지연시간이 늘어나므로 응답을 기다리는 시간이 더 길어짐
- 이 때문에 데이터를 보낼 때 최대한 많은 패킷을 한 번에 보내는 것이 효율적
- 네트워크 상태가 좋지 않으면 패킷 유실 가능성이 생기므로 적절한 송신량을 결정해야 하는데, 이때 한 번에 데이터를 받을 수 있는 크기를 **윈도우 사이즈**라고 함
- TCP 헤더에 Window size라는 Field가 있는데 전체 16bit로 최대 크기는 64Kbyte
- 최근에는 속도가 향상되고 전송할 데이터도 많기 때문에 헤더를 변경할 수 있는데, Fixed Header를 갖고 있기 때문에 16bit를 변경하는 것이 아니라 뒤의 자리를 무시해버리고 하나씩 shift 시켜서 표시할 수 있음
- 네트워크 상황에 따라서 이 윈도우 사이즈를 조절하는 것이 **슬라이딩 윈도우**



### 3방향 핸드셰이크

- 유실 없는 안전한 통신을 위해 통신 시작 전, 사전 연결 작업 진행

- 3번의 패킷을 주고 받으면서 통신을 준비하므로 3방향 핸드셰이크라고 부름

- 진행 상황에 따라 상태 정보를 부르는 이름이 다름

  | 상태 정보       | 설명                                                         |
  | --------------- | ------------------------------------------------------------ |
  | **LISTEN**      | 서버에서 서비스를 제공하기 위해 클라이언트의 접속을 받아들일 수 있는 상태 |
  | **SYN-SENT**    | 클라이언트에서 서버로 통신을 시도할 때 SYN 패킷을 보낸 상태  |
  | **SYN-RECEIVE** | 클라이언트의 SYN을 받은 서버의 상태. SYN, ACK로 응답         |
  | **ESTABLISHED** | SYN, ACK를 받은 클라이언트의 상태. ACK를 다시 응답하면 서버도 해당 상태로 변경.<br />서버와 클라이언트 의 연결이 성공적으로 완료 되었음을 나타냄 |

- TCP 플래그 비트 (초기 연결, 응답, 정상 종료, 비정상 종료 등의 통신의 성질을 나타냄)

  | 플래그 정보 | 설명                                                         |
  | ----------- | ------------------------------------------------------------ |
  | SYN         | 연결 시작을 위해 가장 먼저 보내는 시퀀스 비트.<br />연결이 시작될 때 SYN을 1로 표기 |
  | ACK         | SYN 패킷에 응답하는 패킷<br />1로 세팅되면 확인 번호가 유효함을 뜻함<br />SYN 플래그 전송 이후(TCP 연결 시작 이후) 모든 세그먼트에는 항상 이 비트가 1로 세팅 |
  | FIN         | 연결 종료 시 1로 표시. 데이터 전송을 마친 후 정상적으로 양방향 종료 시 사용 |
  | RST         | 연결 종료 시 1로 표시. 연결 강제 종료를 위해 일방적으로 연결을 끊을 때 사용 |
  | URG         | 긴급 데이터의 경우, 1로 표시해 보냄                          |
  | PSH         | 서버 측에서 전송할 데이터가 없거나, 데이터를 버퍼링 없이 응용 프로그램으로 즉시 전달할 것을 지시할 때 사용 |

  - 통신을 처음 시도할 때, 송신자 SYN 플래그에 1을 표기하고, 자신이 사용할 seq no를 적어 보냄
  - 수신측에서는 SYN과 ACK 플래그에 1을 표기해 응답.
    자신이 사용할 시퀀스 번호를 적고. ACK 번호는 송신자가 보낸 시퀀스 번호에 +1을 추가한 값을 넣어 응답 (N번까지 받았으니 N+1번을 달라)
  - 수신자의 패킷을 받은 송신자는 응답 메세지를 보내는데, 이는 기존 메세지에 대한 응답이므로 SYN 플래그는 0, ACK는 1로 설정. 송신자가 보낸 ACK 번호로 시퀀스 번호를 설정해 응답.



## UDP

- 데이터의 유실 파악, 패킷 순서 정렬의 기능이 없고 데이터 전송의 신뢰성을 보장하지 않음
- 음성데이터나 실시간 스트리밍 같은 시간에 민감한 프로토콜이나 애플리케이션에서만 사용
  - 멀티캐스트와 같이 단방향 다수 단말로 송신 시 사용
  - 유실 데이터 전송을 위해 화면이 멈추는 것보다, 유실된 상태로 처리하는 것이 나음
- 통신 시작 전 3-way 핸드쉐이크를 하지 않고, 첫 데이터는 리소스 확보를 위해 인터럽트를 거는 용도로 사용
- 연결 확립만 TCP의 3-way 핸드쉐이크를 사용하고, 이후 실제 데이터 전송은 UDP를 사용하는 경우가 대부분



## TCP와 UDP 비교

| TCP                            | UDP                                  |
| ------------------------------ | ------------------------------------ |
| 연결 지향(Connection Oriented) | 비연결형(Connectionless)             |
| 오류 제어 수행                 | 오류 제어 미수행                     |
| 흐름 제어 수행                 | 흐름 제어 미수행                     |
| 유니캐스트                     | 유니캐스트, 멀티캐스트, 브로드캐스트 |
| 전이중(Full Duplex)            | 반이중(Half Duplex)                  |
| 데이터 전송                    | 실시간 트래픽 전송                   |





### 참고

[윈도우 사이즈의 개념](https://4network.tistory.com/entry/windowsize)
