# 5.2-3 라우팅 / 스위칭

### ✅ 들어가기 전에

- 라우터가 패킷을 처리할 때 수행하는 작업
  1. 경로 정보를 얻어 경로 정보를 정리하는 역할
  2. 정리된 경로 정보를 기반으로 패킷을 포워딩하는 역할
- 클래스리스 네트워크로 전환된 후에는 같은 클래스에 있는 주소도 서브네팅으로 분산되어 존재하므로 기존 보다 경로 정보가 훨씬 많아졌지만 **최적의 경로 정보인 라우팅 테이블을 적절히 유지**해야 함



#### 서머리(Summary) 작업

- **서브넷 단위로 라우팅 정보를 습득하고 라우팅 정보를 최적화하는 작업**
- 패킷의 목적지 주소와 라우팅 테이블 주소가 정확히 일치(Exact Match)하지 않더라도 목적지에 가장 근접한 정보를 찾아 패킷을 포워딩해야 함



------



## 1. 라우팅 동작과 라우팅 테이블

### 홉-바이-홉(Hop-by-Hop) 라우팅과 넥스트 홉(Next Hop)

- 홉(Hop) : 건너뛰는 모습을 의미. 각 패킷이 매 노드(라우터)를 건너가는 양상을 비유적으로 표현
- 넥스트 홉(Next Hop) : 인접한 라우터를 지칭

- 인접한 라우터까지만 경로를 지정하면 인접 라우터에서 최적의 경로를 다시 파악한 후 넥스트 홉으로 패킷을 포워딩 하는 작업을 반복

![라우터/L3 스위치: 3계층 장비](https://oopy.lazyrockets.com/api/v2/notion/image?src=https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F6716bb37-eaf7-4e74-86fa-b7a00247261c%2FUntitled.png&blockId=4957699e-0098-4427-b0e3-15a926e857c4)

### 넥스트 홉 지정 방법

1. 다음 라우터의 IP를 지정하는 방법 (넥스트 홉 IP 주소)
   - 일반적으로 사용하는 방법
2. 라우터의 나가는 인터페이스를 지정하는 방법
   - 상대방 넥스트 홉 라우터의 IP를 모르더라도 MAC 주소를 알아낼 수 있을 때만 사용
3. 라우터의 나가는 인터페이스와 다음 라우터의 IP를 동시에 지정하는 방법
   - VLAN 인터페이스와 같은 논리적 인터페이스 사용



### 라우팅 테이블

- 출발지와 상관없이* 목적지 주소와 라우팅 테이블을 비교해 어느 경로로 포워딩할지 결정
- 라우팅 테이블에 저장하는 정보
  - 목적지 주소
  - 넥스트 홉 IP 주소, 나가는 로컬 인터페이스(선택 가능)

> ✳︎ 출발지 주소를 이용해 라우팅하는 PBR(Policy-Based Routing) 기능도 있으나 특별한 목적으로만 사용



#### 🧐 루프가 없는 3계층 : TTL(Time To Live)

- 3계층의 IP 헤더의 TTL 필드로 패킷이 네트워크에 살아 있는 시간(홉)을 제한
- 하나의 홉을 지날 때마다 TTL 값이 1씩 줄어들고, 0이 되면 네트워크 장비에서 버려짐
- 운영 사이트가 없어지거나 라우팅 루프 현상이 발생해 유령 패킷이 생기는 것을 방지



------



## 2. 라우팅

- 라우터가 경로 정보를 얻어 최적의 경로를 라우팅 테이블에 올려 유지하는 과정



### 다이렉트 커넥티드

- IP 주소를 입력할 때 사용된 IP 주소와 서브넷 마스크로 네트워크 주소 정보를 알 수 있음
- 이 정보로 해당 네트워크에 대한 라우팅 테이블을 자동으로 생성
  - 목적지 네트워크의 넥스트 홉을 connected로 설정
  - 강제로 지울 수 없고 해당 네트워크 설정을 삭제하거나, 비활성화 되어야 사라짐
- 외부 네트워크로 통신하기 위해서는 원격지 네트워크 정보뿐 아니라 다이렉트 커넥티드 정보도 제대로 입력되어 있어야 함



### 스태틱 라우팅

- 관리자가 목적지 네트워크와 넥스트 홉을 라우터에 직접 지정해 경로 정보를 입력

  ```
  ip route NETWORK NETMAST NEXHOP              [네트워크 장비  : 시스코]
  route add -net NETWORK /Prefix gw NEXTHOP    [서버 운영 체제 : 리눅스]
  ```

  > 목적지(네트워크/호스트 - 서브넷/서브넷 마스크)로 가려면 패킷을 넥스트홉으로 보내야 한다는 의미

- 다이렉트 커넥티드와 같은 삭제 정책을 갖고 있으나, 논리 인터페이스는 삭제되지 않을 수 있음

- 변화가 적은 네트워크를 손쉽게 관리할 수 있는 방법

- 만약 많은 라우팅 정보를 처리하고 싶다면 디폴트 라우팅(=디폴트 게이트웨이) 사용

  > 목적지 주소와 서브넷 마스크가 모두 0인 스태틱 라우팅
  > 모든 네트워크 정보를 체크하지 않는다는 의미로 결국 모든 네트워크 라는 의미가 됨
  > 경로 정보가 없는 경우 마지막 대체 경로로 사용

  

### 다이나믹 라우팅

- 대부분의 네트워크에서 사용하는 라우팅
  - 대체 경로를 신속하게 지정할 수 없는 스태틱 라우팅의 단점 보완

- 라우터끼리 자신이 알고 있는 경로 정보나 링크 상태 정보를 교환해 전체 네트워크 정보를 학습
- 이를 통해 장애를 인지하고 트래픽을 우회해 대체 경로로 패킷을 포워딩할 수 있음



### 라우팅 프로토콜

- 일반적으로 유니캐스트 라우팅 프로토콜을 칭함
- 사용하는 역할과 동작 원리에 따라 구분

| 분류 방법 | 분류                     | 설명                                                         | 속하는 프로토콜          |
| --------- | ------------------------ | ------------------------------------------------------------ | ------------------------ |
| 역할      | EGP                      | 서로 다른 AS 간 정보 교환용 라우팅 프로토콜                  | BGP                      |
|           | IGP                      | AS 내부에서 동작하는 라우팅 프로토콜                         | RIP, EIGRP, OSPF, IS- IS |
| 동작원리  | 디스턴스 벡터            | 직접 연결된 장비가 보내준 정보를 기반으로 최적의 경로를 설정하는 라우팅 프로토콜 | RIP, BGP                 |
|           | 어드밴스드 디스턴스 벡터 | 디스턴스 벡터보다 다양한 경로 선정을 위한 요소 존재<br />지난 장비까지 고려해 경로를 선정할 수 있음 | IGRP, EIGRP              |
|           | 링크 스테이트            | 네트워크 망에 속한 장비가 보내준 정보를 기반으로 토폴로지 맵을 만들고 SPF 알고리즘을 이용해 최적의 경로 선정 | OSPF, IS-IS              |



------



# 3. 스위칭

- 패킷이 들어와 라우팅 테이블을 참조하고 최적의 경로를 찾아 외부로 포워딩하는 작업
- **롱기스트 프리픽스 매치 **기법을 이용해 도착지 IP와 가장 가깝게 매칭되는 경로를 선택
- 한 번 스위칭 작업을 수행한 정보는 캐시에 저장하여 성능 저하 방지



---



# 4. 라우팅, 스위칭 우선순위

- 경로 정보를 얻은 방법과 거리를 기준으로 우선순위가 정해짐



### 경로 수집 방법에 따른 가중치

1. 로컬 네트워크(다이렉트 커넥티드)
2. 직접 경로를 지정한 네트워크(스태틱 라우팅)
3. 경로를 전달받은 네트워크(다이나믹 라우팅)



### 라우팅 우선순위

- 관리자가 AD(Administrative Distance, 관리 거리)를 조정가능

| 우선순위 | 구분            | 적용방법 |
| -------- | --------------- | -------- |
| 1        | 롱기스트 매치   | 스위칭   |
| 2        | AD(관리 거리)   | 라우팅   |
| 3        | 코스트          | 라우팅   |
| 4        | 부하 분산(ECMP) | 라우팅   |

 



## 참고

[홉](http://www.ktword.co.kr/test/view/view.php?m_temp1=1478)
