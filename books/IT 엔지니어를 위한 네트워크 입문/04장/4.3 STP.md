# STP
- IT환경에서 SPoF(Single Point of Failure, 단일 장애점)으로 인한 장애를 피하기 위해 노력
	- SPoF는 하나의 시스템이나 구성 요소에서 고장이 발생했을 때, 시스템의 작동이 멈추는 요소
	- 만약 스위치 하나로 네트워크를 구성하면, 스위치 장애는 전체 네트워크 장애를 불러옴
- SPoF를 방지하기 위해 두 대 이상의 스위치로 구성할 수 있지만, 패킷이 네트워크를 따라 계속 진행되어 네트워크 마비시키는 루프 발생 가능

## 루프(loop)
- 네트워크에 연결된 모양이 고리 형태로 돌아오는 상황
- 루프를 명확인 인지하는 경우는 드물지만, 루프가 발생하면 통신이 안되는 상황 발생
- 크게 3가지 이유로 발생하지만, 대부분 브로드캐스트 스톰으로 인한 문제
	- 브로드 캐스트 스톰, 중복 수신(서로 반대 방향으로 도는 프레임 모두 중복되어 수신), MAC 주소 테이블의 불안정 초래(프레임이 계속 돌아 확정적인 MAC주소 테이블 정할 수 없는 경우)

### 브로드캐스트 스톰
![broadcast strom](https://www.oreilly.com/library/view/network-warrior-1st/9780596101510/httpatomoreillycomsourceoreillyimages17342.png)

- 루프 구조로 연결된 상태에서 브로드캐스트(1:N 통신)를 발생시키면, 패킷이 유입된 포트를 제외한 모든 포트로 플러딩
	- 플러딩된 패킷은 다른 스위치로 보내지고, 유입된 포트를 제외하고 또다시 플러딩
	- 브로드캐스트로 인하여 패킷이 도는 경우를 브로드 캐스트 스톰이라고 부름
- 3계층 헤더에 TTL(Time to Live)가 있어, 패킷 수명을 갖지만, 2계층 헤더에는 TTL과 같은 매커니즘이 없어 패킷이 죽지 않고 계속 살아남음
	- 네트워크에 접속된 단말 속도가 느려지고, 네트워크 접속 속도가 느려지는 상태가 지속, 반복됨

### 스위치 MAC 러닝 중복 문제
- 루프 구조는 유니캐스트에도 문제를 일으킴
	- 수신되는 스위치에서도 문제가 발생할 수 있지만, 중간에 있는 스위치에서 MAC 러닝 문제 발생
	- 스위치는 출발지 MAC주소를 학습하는데, 돌아돌아 들어간 패킷 간의 포트가 달라 MAC주소를 정상적인 방식으로 학습할 수 없음
	- 동일한 MAC 주소가 여러 포트에서 학습되어 반복적으로 갱신되는 MAC 어드레스 프래핑(MAC address Flapping)현상

![MAC address Flapping](https://download.huawei.com/mdl/image/download?uuid=e39d1349cd3743b8955664cd03cb38db)

- 들어오는 포트에 따라 같은 MAC 주소에 대한 정보가 계속 갱신되는 현상
- SPoF를 방지하기 위해 특정 연결을 차단하는 등의 작업이 필요한데, 수동적으로 하기 어려움

## STP(Spanning Tree Protocl)
- 루프를 확인하고 적절히 포트를 사용하지 못하게 만들어 루프를 예방하는 메커니즘

![BPDU](https://t1.daumcdn.net/cfile/tistory/17166D264C2894CE01)

- STP를 활용하기 위해 전체 스위치가 어떻게 연결된지 알아야 함
	- 스위치 간에 정보를 전달하는 방법 필요,
	- BPDU(Bridge Protocol Data Unit)을 활용해 전체 네트워크 트리를 만들어 루프 구간 확인

### 스위치 포트의 상태 및 변경 과정
- STP가 동작 중인 스위치에서 루프를 막기 위해 스위치를 차단함
	- 해당 포트로 트래픽이 흘러도 BPDU를 기다려 학습, 구조를 파악한 후 트래픽을 흘리거나 차단 상태 유지
	- 상태에 따라 4가지로 구분
- 4가지 단계
	- Blocking
		- 패킷 데이터를 차단한 상태로 상대방이 보내는 BPDU 기다림
		- 20초인 Max Age동안 받지 못했거나, 후순위 BPDU를 받은 경우 리스닝 상태로 변경
		- 기본 교환 주기는 2초이고, 10번의 BPDU 기다림
	- Listening
		- 해당 포트가 전송 상태로 변경되는 것을 결정, 준비
		- 자신의 BPDU 정보를 상대방에게 전송
		- 15초 대기
	- Learning
		- 해당 포트를 포워딩하기로 결정, 실제로 패킷 포워딩이 일어날 때 스위치가 곧바로 동작하도록 MAC 주소 러닝하는 단계
		- 15초 대기
	- Forwarding
		- 패킷 포워딩 하는 단계로 정상적 통신 가능
- 스위치에 새로운 장비가 붙으면 위의 단계를 거치고, 50여초 소요
	- 스위치 루프를 예방하기 위해 방어적으로 동작
	- 새로 연결된 단말이 스위치일 가능성도 있어 BPDU를 일정 시간 이상 기다리며 파악

### STP 동작 방식
- 네트워크에서 루트가 되는 스위치 선출, 그 스위치를 통해 모든 BPDU가 교환됨, 그러한 스위치를 루트 스위치라고 함
	- 모든 스위치는 처음에 자신을 루트 스위치로 인식 & 동작
	- BPDU를 통해 2초마다 자신이 루트 스위치임을 알림, 새로운 스위치가 들어오면 서로 교환된 BPDU에 들어있는 브릿시 ID 값 비교
		- 브릿지 ID값이 더 작은 스위치를 루트 스위치로 선정
- STP 동작 순서
	- 하나의 루트 스위치 선정
	- 루트가 아닌 스위치 중 하나의 루트 포트 선정
		- 루트 브릿지로 가는 경로가 가장 짧은 포트를 루트 포트
		- 루트 브릿지에서 보낸 BPDU를 받는 포트
	- 하나의 세그먼트에 하나의 지정 포트 선정
		- 스위치와 스위치가 연결되는 포트는 하나의 지정 포트 선정
		- 스위치 간 연결에서 이미 루트 포트로 선정된 경우, 반대쪽이 지정 포트로 선정, 양쪽 모두 포워딩 상태
		- 스위치 간의 연결에서 아무도 루트 포트가 아닌 경우, 한쪽은 지정 포트로 선정, 다른 한쪽은 대체 포트가 되어 차단 상태

## 향상된 STP
- STP는 루프 방지 등을 위해 BPDU전달 시간 고려 → 포트가 포워딩 상태로 변경될 때까지 30~50초 소요
- 스위치에 여러 개의 VLAN이 있으면 VLAN별 STP를 계산하여 부하 발생

### RSTP(Rapid Spanning Protocol)
- STP의 정상적인 경로에 문제가 발생한 경우 백업 경로를 활성화 하는데 30~50초 소요
	- 백업 경로 활성화 시간 문제를 해결하기 위하여 RSTP 개발, 2~3초 이내로 연결 및 세션 유지 가능
- 기본 구성은 STP와 같지만, BPDU메시지 형식이 다양해져 여러 상태 메시지 교환 가능
	- STP는 상태 변경과 관련하여 TCN, TCA BPDU 두 가지 메시지만 있지만, RSTP는 8개 비트를 활용하여 다양한 정보 주고 받음

### MST(Multiple Spanning Tree)
- 일반적인 STP는 CST(Comman Spanning Tree)라고 부름
	- VLAN개수와 상관없이 스패닝 트리 한 개만 동작
	- VLAN이 많더라도 스패닝 트리는 한 개만 동작, 스위치 부하 적음
	- CST는 루프가 생기는 구조에서 자원을 효율적으로 활용하기 어려움
	- VLAN마다 최적 경로가 다를 수 있는 상황 고려해야 함
- 위의 문제를 해결하기 위해 PVST(Per Vlan Spanning Tree) 개발
	- VLAN마다 다른 스패닝 트리 동작
	- 최적 경로를 디자인, VLAN마다 별도 포트 지정할 수 있음
	- 하지만 더 많은 비용 부담해야함
- CST, PVST단점을 보완하기 위한 MST개발
- MST
	- 여러 개의 VLAN 그룹으로 묶고, 그룹마다 별도의 스패닝 트리 동작
	- PVST보다 적은 스패닝 트리 활용하면서 PVST에서 경로 활용의 장점도 있음
	- 경로의 개수, 용도에 따라 MST 스패닝 트리 프로토콜 프로세스 개수 정의